{% extends 'layout.html' %}
{% block content %}

    <link rel="stylesheet" href="{{ url_for('static', filename='css/devices.css') }}"> 


    <div class="devices">
        {% include 'header.html' %}
        <div class="bento">
            <div class="divider colored">
                <h1>Devices</h1>
                <table>
                    <thead>
                        <tr>
                            <th>Ip</th>
                            <th>Status</th>
                            <th>Location</th>
                            <th> Actions </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set ns = namespace(LineNb=0) %}
                        {% for el in liste_song_player  %}
                            {% if ns.LineNb < 13 %}
                                {% set ns.LineNb = ns.LineNb + 1 %}
                                <tr>
                                    <td> {{ el['IP_adress'] }} </td>
                                    <td id="status-{{ el['id_player'] }}" class="{% if el['state'] == 'ONLINE' %}green{% elif el['state'] == 'OFFLINE' %}red{% endif %}">
                                        {{ el['state'] }}
                                    </td>
                                    <td> {{ el['name_place'] }}</td>
                                    <td class="actions-cell">
                                        <div class="buttons-wrapper">
                                            <a href="/delete/{{ el['id_player'] }}" class="custom-btn btn-red" onclick="return confirm('Confirm deletion?')">Delete</a>
                                            <a href="/update/{{ el['id_player'] }}" class="custom-btn btn-yellow" onclick="return confirm('Confirm update?')">Update</a>
                                        </div>
                                    </td>
                                </tr>
                            {%endif%}
                        {% endfor %}
                            
                        <!-- Completion of empty lines -->
                        {% for i in range(ns.LineNb, 13) %}
                            <tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
                        {% endfor %}
                        <tr>
                            <td> Offline : <span class="red"> {{ nb_off }}</span></td>
                            <td> Playing : <span class="green"> {{ nb_on }}</span></td>
                            <td> <p style="font-size: 0.8em; font-style: italic; margin-bottom: 10px; color: gray;"> Last auto-update: <span id="last-update-time">--:--:--</span></p></td>
                            <td>&nbsp;</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<script>
    // On définit le nom de l'organisation (donnée par le controller)
    const orga_name = "{{orga_name}}".trim();

    //cette fonction permet de mettre a jour les statut sans recharger tout la page 
    function refreshStatuses() {
        console.log("Démarrage de la mise à jour automatique...");
        // la fonction fait un appel au controleur
        fetch(`/auto_update_status/${orga_name}`)
            .then(response => response.json()) // reponse est la requête http entière nous on la veut en json
            .then(data => {
                // data est le JSON (qui pour chaque devices on un dico de type {id_player':id_player,'state':state})
                console.log("Données reçues du serveur :", data);
                data.forEach(device => {
                    // device est un objet JavaScript qui est contenu dans data qui un Json
                    // On cherche la cellule <td> par son ID 
                    const statusTd = document.getElementById(`status-${device.id_player}`);
                    
                    if (statusTd) {
                        // Mise à jour du texte
                        statusTd.textContent = device.state;

                        // Mise à jour de la couleur 
                        // car le if dans la class de la balise td ne se fait q'un fois au chargement de la page
                        if (device.state === 'ONLINE') {
                            statusTd.className = 'green';
                        } else if (device.state === 'OFFLINE') {
                            statusTd.className = 'red';
                        }
                    }
                });

                const now = new Date();

                // On récupère les valeurs brutes
                const h = now.getHours();
                const m = now.getMinutes();
                const s = now.getSeconds();

                // On assemble avec les barres verticales
                const displayTime = `${h}:${m}:${s}`;

                document.getElementById('last-update-time').textContent = displayTime;
            })
            .catch(err => console.error("Erreur auto-update:", err)); 
            // si il y a une erreur elle s'affichera dans la console sans ça on ne pouras pas savoir que sa na pas marcher 
    }

    // Lancer le rafraîchissement toutes les 25 secondes
    setInterval(refreshStatuses, 25000);
</script>
{% endblock %}